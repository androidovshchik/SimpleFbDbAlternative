!function(t){var e={};function n(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(r,s,function(e){return t[e]}.bind(null,s));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=6)}([function(t,e,n){"use strict";var r=this&&this.__decorate||function(t,e,n,r){var s,o=arguments.length,i=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(i=(o<3?s(i):o>3?s(e,n,i):s(e,n))||i);return o>3&&i&&Object.defineProperty(e,n,i),i};Object.defineProperty(e,"__esModule",{value:!0});const s=n(1),o=n(9),i=n(2),a=n(14);let c=class{};c.TEST=!1,c.DEBUG=!1,c=r([s.Module({controllers:[o.AppController],providers:[a.BattlesGateway,i.AppService]})],c),e.AppModule=c},function(t,e){t.exports=require("@nestjs/common")},function(t,e,n){"use strict";var r=this&&this.__decorate||function(t,e,n,r){var s,o=arguments.length,i=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(i=(o<3?s(i):o>3?s(e,n,i):s(e,n))||i);return o>3&&i&&Object.defineProperty(e,n,i),i},s=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),a=o(n(10)),c=n(5),u=o(n(11)),l=n(12),p=n(3),d=n(0),f=o(n(4));let h=class{constructor(){this.onFight$=new l.Subject,this.battlesDb=new a.default({inMemoryOnly:!0,timestampData:!0}),this.storeDb=new a.default({filename:"store.db",autoload:!0,onload(t){t&&console.error(t)},beforeDeserialization:t=>d.AppModule.DEBUG?t:u.default.decompress(t,{inputEncoding:"BinaryString"}),afterSerialization:t=>d.AppModule.DEBUG?t:u.default.compress(t,{outputEncoding:"BinaryString"})}),this.battlesDb.ensureIndex({fieldName:"_path",unique:!0},t=>{t&&console.error(t)}),this.storeDb.ensureIndex({fieldName:"_path",unique:!0},t=>{t&&console.error(t)})}insertDocument(t,e,n,r){const s="battles"==t?this.battlesDb:this.storeDb,o=e.splitDoc(n);o.length>0?this.removeDocument(t,e,n=>{n?r(n):s.insert(o,n=>{r(n),n||this.getDocument(t,e,(t,e)=>{t||this.onFight$.next(Object.assign({},e,{_event:c.NoteEvent.INSERT}))})})},!1):r(null)}updateDocument(t,e,n,r,s,o){if(s)if(o<s.length){("battles"==t?this.battlesDb:this.storeDb).update({_path:s[o]._path},{$set:s[o]},{upsert:!0},n=>{n?r(n):this.updateDocument(t,e,null,r,s,o+1)})}else r(null),this.getDocument(t,e,(t,e)=>{t||this.onFight$.next(Object.assign({},e,{_event:c.NoteEvent.UPDATE}))});else{const s=e.splitDoc(n);s.length>0?this.updateDocument(t,e,null,r,s,0):r(null)}}getDocument(t,e,n){const r="battles"==t?this.battlesDb:this.storeDb;e.isNonEmpty()?r.find({_path:new RegExp(`^${e}`)},(t,r)=>{t?n(t):n(null,e.joinDocs(r))}):n(null,e.joinDocs(r.getAllData()))}getCollection(t,e,n){this.getDocument(t,e,(t,e)=>{if(t)n(t,[]);else{const t=Object.keys(e);n(null,t.reduce((t,n)=>{if(p.Folder.format(n).length>0){const r=e[n];f.default.isPlainObject(r)&&t.push(r)}return t},[]))}})}removeDocument(t,e,n,r=!0){("battles"==t?this.battlesDb:this.storeDb).remove(e.isNonEmpty()?{_path:new RegExp(`^${e}`)}:{},{multi:!0},(t,s)=>{n(t),t||s>0&&r&&this.onFight$.next(Object.assign({},e.toEmptyDoc(),{_event:c.NoteEvent.REMOVE}))})}onModuleDestroy(){this.battlesDb.removeIndex("_path",t=>{t&&console.error(t)}),this.storeDb.removeIndex("_path",t=>{t&&console.error(t)})}};h=r([i.Injectable(),s("design:paramtypes",[])],h),e.AppService=h},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=r(n(4));class o{constructor(t){this.path="",this.length=0,this.backslashes=0,this.path=o.format(t),this.length=this.path.length,this.backslashes=this.path.split("/").length-(this.length>0?0:1)}splitDoc(t,e=0,n=s.default.isPlainObject(t)){if(s.default.isObjectLike(t)){n&&(delete t._id,delete t.createdAt,delete t.updatedAt,t._temp=null);const r=Object.keys(t);return r.reduce((i,a,c)=>{if(/[$.\0]/.test(a))delete t[a];else{const r=t[a];if(s.default.isNull(r))t[a]=void 0;else if(s.default.isObjectLike(r)){const c=n&&s.default.isPlainObject(r),u=new o(`${this.path}/${a}`).splitDoc(r,e+1,c);c&&o.format(a).length>0&&(i=i.concat(u),delete t[a])}}return n&&c==r.length-1&&i.push(Object.assign({},t,this.toEmptyDoc())),i},[])}return[]}joinDocs(t){let e=this.toEmptyDoc();return t.sort((t,e)=>t._backslashes>e._backslashes?1:t._backslashes<e._backslashes?-1:0),t.forEach(t=>{const n=this.mergeDoc(e,t);n&&(e=n)}),e}mergeDoc(t,e){if(!this.includes(e._path))throw Error("Field [_path] of param [child] must start with [this.path]");const n=o.format(e._path.substring(this.length));return n.length>0?(s.default.set(t,n.split("/"),e),null):Object.assign(t,e)}extractDoc(t,e){if(!this.includes(e))throw Error("Param [subpath] must start with [this.path]");return(e=o.format(e.substring(this.length))).length>0?s.default.get(t,e.split("/"),null):t}toEmptyDoc(){return{_path:this.path,_backslashes:this.backslashes}}includes(t){return t.startsWith(this.path)}isNonEmpty(){return this.length>0}toString(){return this.path}static format(t){return t.replace(/\.|\0|\s|\$/g,"").replace(/\/\/+/g,"/").replace(/^\/|\/$/,"")}}e.Folder=o},function(t,e){t.exports=require("lodash")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.INSERT=10]="INSERT",t[t.UPDATE=20]="UPDATE",t[t.REMOVE=30]="REMOVE"}(e.NoteEvent||(e.NoteEvent={}))},function(t,e,n){t.exports=n(7)},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(s,o){function i(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){t.done?s(t.value):new n(function(e){e(t.value)}).then(i,a)}c((r=r.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=n(8),o=n(0);console.log=()=>{},Date.prototype.toJSON=function(){return this.getTime()},function(){return r(this,void 0,void 0,function*(){const t=yield s.NestFactory.create(o.AppModule,{bodyParser:!0});yield t.listen(3210,"0.0.0.0")})}().catch(t=>{console.error(t)})},function(t,e){t.exports=require("@nestjs/core")},function(t,e,n){"use strict";var r,s=this&&this.__decorate||function(t,e,n,r){var s,o=arguments.length,i=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(i=(o<3?s(i):o>3?s(e,n,i):s(e,n))||i);return o>3&&i&&Object.defineProperty(e,n,i),i},o=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},i=this&&this.__param||function(t,e){return function(n,r){e(n,r,t)}},a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const c=n(1),u=n(2),l=n(3),p=n(0),d=a(n(13));let f=r=class{constructor(t){this.appService=t}getIp(){return d.default.address()}insertDocument(t,e,n,s,o){t.get("user-agent")==r.USER_AGENT?this.appService.insertDocument(e,new l.Folder(n),s,t=>{o.status(c.HttpStatus.OK).json({_error:t})}):o.status(c.HttpStatus.BAD_REQUEST).send()}updateDocument(t,e,n,s,o){t.get("user-agent")==r.USER_AGENT?this.appService.updateDocument(e,new l.Folder(n),s,t=>{o.status(c.HttpStatus.OK).json({_error:t})}):o.status(c.HttpStatus.BAD_REQUEST).send()}getDocument(t,e,n,s){t.get("user-agent")==r.USER_AGENT?this.appService.getDocument(e,new l.Folder(n),(t,e)=>{p.AppModule.TEST?s.status(c.HttpStatus.OK).json(JSON.parse(JSON.stringify(e,(t,e)=>"_id"===t?void 0:e))):s.status(c.HttpStatus.OK).json(Object.assign({},e,{_error:t}))}):s.status(c.HttpStatus.BAD_REQUEST).send()}getCollection(t,e,n,s){t.get("user-agent")==r.USER_AGENT?this.appService.getCollection(e,new l.Folder(n),(t,e)=>{p.AppModule.TEST?s.status(c.HttpStatus.OK).json(JSON.parse(JSON.stringify(e,(t,e)=>"_id"===t?void 0:e))):s.status(c.HttpStatus.OK).json({docs:e,_error:t})}):s.status(c.HttpStatus.BAD_REQUEST).send()}removeDocument(t,e,n,s){t.get("user-agent")==r.USER_AGENT?this.appService.removeDocument(e,new l.Folder(n),t=>{s.status(c.HttpStatus.OK).json({_error:t})}):s.status(c.HttpStatus.BAD_REQUEST).send()}};f.USER_AGENT="Battle-Server",s([c.Get(),o("design:type",Function),o("design:paramtypes",[]),o("design:returntype",String)],f.prototype,"getIp",null),s([c.Post("db/:db/doc/:path(*)"),i(0,c.Req()),i(1,c.Param("db")),i(2,c.Param("path")),i(3,c.Body()),i(4,c.Res()),o("design:type",Function),o("design:paramtypes",[Object,String,String,Object,Object]),o("design:returntype",void 0)],f.prototype,"insertDocument",null),s([c.Put("db/:db/doc/:path(*)"),i(0,c.Req()),i(1,c.Param("db")),i(2,c.Param("path")),i(3,c.Body()),i(4,c.Res()),o("design:type",Function),o("design:paramtypes",[Object,String,String,Object,Object]),o("design:returntype",void 0)],f.prototype,"updateDocument",null),s([c.Get("db/:db/doc/:path(*)"),i(0,c.Req()),i(1,c.Param("db")),i(2,c.Param("path")),i(3,c.Res()),o("design:type",Function),o("design:paramtypes",[Object,String,String,Object]),o("design:returntype",void 0)],f.prototype,"getDocument",null),s([c.Get("db/:db/collection/:path(*)"),i(0,c.Req()),i(1,c.Param("db")),i(2,c.Param("path")),i(3,c.Res()),o("design:type",Function),o("design:paramtypes",[Object,String,String,Object]),o("design:returntype",void 0)],f.prototype,"getCollection",null),s([c.Delete("db/:db/doc/:path(*)"),i(0,c.Req()),i(1,c.Param("db")),i(2,c.Param("path")),i(3,c.Res()),o("design:type",Function),o("design:paramtypes",[Object,String,String,Object]),o("design:returntype",void 0)],f.prototype,"removeDocument",null),f=r=s([c.Controller(),o("design:paramtypes",[u.AppService])],f),e.AppController=f},function(t,e){t.exports=require("nedb")},function(t,e){t.exports=require("lzutf8")},function(t,e){t.exports=require("rxjs")},function(t,e){t.exports=require("ip")},function(t,e,n){"use strict";var r=this&&this.__decorate||function(t,e,n,r){var s,o=arguments.length,i=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(i=(o<3?s(i):o>3?s(e,n,i):s(e,n))||i);return o>3&&i&&Object.defineProperty(e,n,i),i},s=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(15),a=n(16),c=n(2),u=n(5),l=n(3),p=o(n(4));let d=class{constructor(t){this.appService=t,this.paths=new Set}afterInit(t){t.on("error",(t,e)=>{e&&console.error(e)}),this.appService.onFight$.asObservable().subscribe(e=>{const n=new l.Folder(e._path);this.paths.forEach(r=>{if(n.includes(r)){const s=l.Folder.format(`db/battles/doc/${r}`);if(e._event==u.NoteEvent.REMOVE)t.emit(s,null);else{const o=n.extractDoc(e,r);t.emit(s,o?Object.assign({},o,{_event:e._event}):null)}}})})}onSubscribe(t,e){try{e=JSON.parse(e),p.default.isPlainObject(e)&&p.default.isString(e.path)&&this.paths.add(l.Folder.format(e.path))}catch(t){}}onUnsubscribe(t,e){try{e=JSON.parse(e),p.default.isPlainObject(e)&&p.default.isString(e.path)&&this.paths.delete(l.Folder.format(e.path))}catch(t){}}};r([i.WebSocketServer(),s("design:type",a.Server)],d.prototype,"server",void 0),r([i.SubscribeMessage("subscribe"),s("design:type",Function),s("design:paramtypes",[Object,Object]),s("design:returntype",void 0)],d.prototype,"onSubscribe",null),r([i.SubscribeMessage("unsubscribe"),s("design:type",Function),s("design:paramtypes",[Object,Object]),s("design:returntype",void 0)],d.prototype,"onUnsubscribe",null),d=r([i.WebSocketGateway(),s("design:paramtypes",[c.AppService])],d),e.BattlesGateway=d},function(t,e){t.exports=require("@nestjs/websockets")},function(t,e){t.exports=require("ws")}]);